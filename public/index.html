<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CPAP データ入力</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="max-w-md mx-auto p-4 pt-8">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">CPAP データ入力</h1>

    <form id="cpap-form" class="space-y-4">
      <div>
        <label for="recorded_date" class="block text-sm font-medium text-gray-700 mb-1">
          記録日
        </label>
        <input
          type="date"
          id="recorded_date"
          name="recorded_date"
          required
          class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
      </div>

      <div>
        <label for="ahi" class="block text-sm font-medium text-gray-700 mb-1">
          AHI（無呼吸低呼吸指数）
        </label>
        <input
          type="number"
          id="ahi"
          name="ahi"
          step="0.1"
          min="0"
          required
          placeholder="例: 2.5"
          class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
      </div>

      <div>
        <label for="ai" class="block text-sm font-medium text-gray-700 mb-1">
          AI（無呼吸指数）
        </label>
        <input
          type="number"
          id="ai"
          name="ai"
          step="0.1"
          min="0"
          placeholder="例: 1.2"
          class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
      </div>

      <div>
        <label for="leak" class="block text-sm font-medium text-gray-700 mb-1">
          リーク（L/min）
        </label>
        <input
          type="number"
          id="leak"
          name="leak"
          step="0.1"
          min="0"
          placeholder="例: 12.0"
          class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
      </div>

      <div>
        <label for="usage_hours" class="block text-sm font-medium text-gray-700 mb-1">
          使用時間（時間）
        </label>
        <input
          type="number"
          id="usage_hours"
          name="usage_hours"
          step="0.1"
          min="0"
          max="24"
          placeholder="例: 7.5"
          class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
      </div>

      <div>
        <label for="notes" class="block text-sm font-medium text-gray-700 mb-1">
          メモ
        </label>
        <textarea
          id="notes"
          name="notes"
          rows="3"
          placeholder="気になったことなど"
          class="w-full px-4 py-3 text-lg border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        ></textarea>
      </div>

      <button
        type="submit"
        id="submit-btn"
        class="w-full bg-blue-600 text-white py-4 text-lg font-medium rounded-lg hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
      >
        送信
      </button>
    </form>

    <div id="message" class="mt-4 p-4 rounded-lg hidden"></div>
  </div>

  <script>
    // 今日の日付をデフォルト値に設定（ローカルタイムゾーン基準）
    function getTodayString() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }
    document.getElementById('recorded_date').value = getTodayString();

    const form = document.getElementById('cpap-form');
    const submitBtn = document.getElementById('submit-btn');
    const messageDiv = document.getElementById('message');

    function showMessage(text, isError = false) {
      messageDiv.textContent = text;
      messageDiv.className = `mt-4 p-4 rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
      messageDiv.classList.remove('hidden');
    }

    function hideMessage() {
      messageDiv.classList.add('hidden');
    }

    function setLoading(loading) {
      submitBtn.disabled = loading;
      submitBtn.textContent = loading ? '送信中...' : '送信';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideMessage();
      setLoading(true);

      const formData = new FormData(form);
      const data = {
        recorded_date: formData.get('recorded_date'),
        ahi: formData.get('ahi') ? parseFloat(formData.get('ahi')) : null,
        ai: formData.get('ai') ? parseFloat(formData.get('ai')) : null,
        leak: formData.get('leak') ? parseFloat(formData.get('leak')) : null,
        usage_hours: formData.get('usage_hours') ? parseFloat(formData.get('usage_hours')) : null,
        notes: formData.get('notes') || null,
      };

      try {
        const response = await fetch('/api/cpap', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          showMessage('データを保存しました');
          form.reset();
          document.getElementById('recorded_date').value = getTodayString();
        } else {
          const errorData = await response.json().catch(() => ({}));
          showMessage(errorData.message || `エラーが発生しました (${response.status})`, true);
        }
      } catch (error) {
        showMessage('通信エラーが発生しました', true);
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
